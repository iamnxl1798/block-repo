#!/bin/bash
# ======================================================
# üåê Universal Global Git pre-push hook
# Blocks unauthorized repository pushes (GitHub, GitLab, Bitbucket, etc.)
# ======================================================

REMOTE_NAME="$1"
REMOTE_URL="$2"

if [ -z "$REMOTE_URL" ]; then
  REMOTE_URL=$(git remote get-url "$REMOTE_NAME" 2>/dev/null || echo "")
fi

# --- Config ---
WHITELIST_FILE="$HOME/.git/hooks/whitelist.txt"
SENTRY_URL="https://sentry.gem-corp.tech/api/7/store/"
SENTRY_KEY="c04662ba996ca859544095fa54b7d05b"
DEBUG=false

# --- Environment info ---
USER_OS=$(whoami)
GIT_USER=$(git config user.name)
GIT_EMAIL=$(git config user.email)
EXPECTED_REPO_URL=$(git remote get-url origin 2>/dev/null || echo "unknown")
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S")

# ======================================================
# Helper: Send Sentry notification
# ======================================================
send_sentry_notification() {
  local payload=$(cat <<EOF
{
  "message": "‚ùå Unauthorized Git push attempt detected",
  "level": "error",
  "logger": "global.pre-push.hook",
  "platform": "bash",
  "extra": {
    "os_user": "$USER_OS",
    "git_user": "$GIT_USER",
    "git_email": "$GIT_EMAIL",
    "unauthorized_repo": "$REMOTE_URL",
    "expected_repo": "$EXPECTED_REPO_URL",
    "timestamp": "$TIMESTAMP"
  }
}
EOF
  )

  curl -s -X POST "$SENTRY_URL" \
    -H "Content-Type: application/json" \
    -H "X-Sentry-Auth: Sentry sentry_version=7, sentry_client=curl/1.0, sentry_key=$SENTRY_KEY" \
    -d "$payload" >/dev/null 2>&1
}

# ======================================================
# Normalize any Git URL into a consistent form:
#   git@github.com:org/repo.git ‚Üí github.com/org/repo
#   https://gitlab.com/team/repo.git ‚Üí gitlab.com/team/repo
# ======================================================
normalize_url() {
  local url="$1"
  echo "$url" | sed -E '
    s#(ssh://|git@|https://|http://)##;  # remove protocols
    s#:#/#;                              # convert ":" to "/"
    s#^[^@]+@##;                         # drop username before host
    s#//#/#g;                            # collapse double slashes
    s#\.git$##;                          # strip trailing .git
  '
}

# ======================================================
# Step 1: Check whitelist existence
# ======================================================
if [ ! -f "$WHITELIST_FILE" ]; then
  echo "‚ö†Ô∏è  Whitelist not found at: $WHITELIST_FILE"
  echo "   Create it with one allowed Git repo URL per line (raw from git remote -v)."
  exit 1
fi

# ======================================================
# Step 2: Normalize remote URL
# ======================================================
NORMALIZED_REMOTE=$(normalize_url "$REMOTE_URL")

$DEBUG && echo "[DEBUG] Remote URL: $REMOTE_URL"
$DEBUG && echo "[DEBUG] Normalized: $NORMALIZED_REMOTE"

# ======================================================
# Step 3: Check whitelist (supports wildcards)
# ======================================================
AUTHORIZED=0

while IFS= read -r line || [ -n "$line" ]; do
  line=$(echo "$line" | tr -d '\r' | xargs)
  [[ -z "$line" || "$line" == \#* ]] && continue

  # Normalize the whitelist entry too
  NORMALIZED_LINE=$(normalize_url "$line")

  # Wildcard support (github.com/org/*)
  if [[ "$NORMALIZED_LINE" == *"*"* ]]; then
    PATTERN="^${NORMALIZED_LINE//\*/.*}$"
    if [[ "$NORMALIZED_REMOTE" =~ $PATTERN ]]; then
      AUTHORIZED=1
      break
    fi
  elif [[ "$NORMALIZED_REMOTE" == "$NORMALIZED_LINE" ]]; then
    AUTHORIZED=1
    break
  fi
done < "$WHITELIST_FILE"

# ======================================================
# Step 4: Handle unauthorized push
# ======================================================
if [ $AUTHORIZED -ne 1 ]; then
  echo "‚ùå Push to unauthorized repo '$REMOTE_NAME' blocked!"
  echo "   URL: $REMOTE_URL"
  echo "   Normalized: $NORMALIZED_REMOTE"
  echo ""
  echo "üîí Allowed repositories (whitelist):"
  cat "$WHITELIST_FILE"
  echo ""
  send_sentry_notification
  exit 1
fi

# ======================================================
# Step 5: Chain to local pre-push (if any)
# ======================================================
LOCAL_HOOK=".git/hooks/pre-push"

if [ -x "$LOCAL_HOOK" ]; then
  echo "[Global Hook] Running local pre-push hook from $LOCAL_HOOK..."
  "$LOCAL_HOOK" "$@"
  LOCAL_STATUS=$?
  if [ $LOCAL_STATUS -ne 0 ]; then
    echo "[Global Hook] Local pre-push hook failed (exit code $LOCAL_STATUS)."
    exit $LOCAL_STATUS
  fi
else
  echo "[Global Hook] No local pre-push hook found ‚Äî continuing."
fi

exit 0
